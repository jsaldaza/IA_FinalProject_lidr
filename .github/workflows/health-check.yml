name: ğŸ©º Health Check

on:
  schedule:
    # Ejecuta cada hora durante horas laborales (UTC)
    - cron: "0 8-20 * * 1-5"
  workflow_dispatch: # Permite ejecuciÃ³n manual

jobs:
  health-check:
    name: ğŸ” Check Application Health
    runs-on: ubuntu-latest
    env:
      BACKEND_URL: ${{ secrets.BACKEND_URL != '' && secrets.BACKEND_URL || '' }}
      FRONTEND_URL: ${{ secrets.FRONTEND_URL != '' && secrets.FRONTEND_URL || '' }}

    steps:
      - name: âš™ï¸ Validate inputs
        id: guard
        shell: bash
        run: |
          run_backend=true
          run_frontend=true

          if [ -z "$BACKEND_URL" ]; then
            echo "âš ï¸ BACKEND_URL is not set; backend, DB, and API docs checks will be skipped." >&2
            run_backend=false
          fi

          if [ -z "$FRONTEND_URL" ]; then
            echo "âš ï¸ FRONTEND_URL is not set; frontend check will be skipped." >&2
            run_frontend=false
          fi

          echo "run_backend=$run_backend" >> "$GITHUB_OUTPUT"
          echo "run_frontend=$run_frontend" >> "$GITHUB_OUTPUT"

      - name: ğŸ¥ Check Backend Health
        if: steps.guard.outputs.run_backend == 'true'
        run: |
          echo "Checking backend health..."
          response=$(curl -L --fail --retry 2 --max-time 15 --silent --output /dev/null --write-out "%{http_code}" "$BACKEND_URL/health" || echo "000")
          if [ "$response" = "200" ]; then
            echo "âœ… Backend is healthy (HTTP $response)"
          else
            echo "âŒ Backend health check failed (HTTP $response)"
            exit 1
          fi

      - name: ğŸŒ Check Frontend
        if: steps.guard.outputs.run_frontend == 'true'
        run: |
          echo "Checking frontend accessibility..."
          response=$(curl -L --fail --retry 2 --max-time 15 --silent --output /dev/null --write-out "%{http_code}" "$FRONTEND_URL" || echo "000")
          if [ "$response" = "200" ]; then
            echo "âœ… Frontend is accessible (HTTP $response)"
          else
            echo "âŒ Frontend check failed (HTTP $response)"
            exit 1
          fi

      - name: ğŸ—„ï¸ Check Database Connectivity
        if: steps.guard.outputs.run_backend == 'true'
        run: |
          echo "Checking database connectivity through API..."
          response=$(curl -L --fail --retry 2 --max-time 15 --silent --output /dev/null --write-out "%{http_code}" "$BACKEND_URL/db-test" || echo "000")
          if [ "$response" = "200" ]; then
            echo "âœ… Database is connected (HTTP $response)"
          else
            echo "âŒ Database connectivity check failed (HTTP $response)"
            exit 1
          fi

      - name: ğŸ“Š Check API Documentation
        if: steps.guard.outputs.run_backend == 'true'
        run: |
          echo "Checking API documentation..."
          response=$(curl -L --retry 2 --max-time 15 --silent --output /dev/null --write-out "%{http_code}" "$BACKEND_URL/api-docs" || echo "000")
          if [ "$response" = "200" ] || [ "$response" = "301" ] || [ "$response" = "302" ]; then
            echo "âœ… API docs are accessible (HTTP $response)"
          else
            echo "âš ï¸ API docs check returned (HTTP $response) - might be disabled in production"
          fi

      - name: ğŸ“ Health Summary
        if: always()
        run: |
          echo "ğŸ©º Health Check Summary:"
          echo "========================"
          echo "Backend: ${{ secrets.BACKEND_URL }}"
          echo "Frontend: ${{ secrets.FRONTEND_URL }}"
          echo "Timestamp: $(date)"
          echo "========================"
